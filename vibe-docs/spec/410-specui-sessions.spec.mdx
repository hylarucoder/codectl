---
title: Spec UI — 多会话（Sessions）规范
specVersion: 0.1.0
status: draft
lastUpdated: {auto}
---

# Spec UI — 多会话（Sessions）规范（草案）

本规范定义在 Spec 工作台中“并行开启多个规范会话”的行为、数据模型、快捷键与可选的持久化格式，确保在一个开发周期内可以围绕多个规范并行讨论、沉淀与切换，从而强化 SDD 的效率闭环。

## 1. 目标与非目标
- 目标
  - 允许同时打开多个 `.spec.mdx` 形成独立会话，每个会话维护各自的聊天日志、输入历史与视图状态（Markdown/日志滚动位置）。
  - 支持低摩擦的会话管理：新建、关闭、切换、列出，均可通过键盘完成。
  - 保持 UI 流畅与状态隔离，切换会话时不影响其他会话的渲染与日志。
- 非目标
  - 不要求为会话日志提供强制持久化（可选导出即可）。
  - 不涉及 LLM 对话本身的提示/系统规则规范（另见 Spec 工作流与生成规范相关规范）。

## 2. 概念与术语
- 会话（Session）：绑定到一个 `.spec.mdx` 的交互上下文，包含“聊天日志/输入历史/视图状态”等。
- 会话栏：用于展示已打开会话的可视化控件（建议标签栏 Tab）。
- 当前会话：用户正在查看/输入的会话；高亮显示。

## 3. 数据模型（建议）
会话对象（内存态）建议包含：
- `id: string`：稳定标识，可由 `specPath` 哈希或增量分配；用于程序内索引。
- `specPath: string`：关联的规范文件路径；作为“唯一真源”。
- `title: string`：会话标题，优先取 frontmatter.title；缺省为文件名。
- `createdAt: string (ISO)` / `lastActiveAt: string (ISO)`：用于排序与提示。
- `inputHistory: string[]`：输入历史（最近 N 条）。
- `log: {ts: ISO, role: string, text: string}[]`：会话日志；短期内存存储。
- `view: {markdownScroll: int, logScroll: int}`：视图滚动位置。
- `mdCacheKey: string`：Markdown 缓存索引（结合宽度/修改时间）。

注：以上字段为实现建议，非持久化合同。导出/导入格式见第 6 节。

## 4. 交互与快捷键（MUST/SHOULD）
- MUST：允许在 Spec 文件表中选中条目后“新开会话”。
- MUST：提供键盘切换当前会话能力；切换后保持各自视图状态（Markdown/日志滚动位置）。
- SHOULD：
  - `Ctrl+T` 新开会话（将当前文件表选中项加入会话栏并激活）。
  - `Ctrl+W` 关闭当前会话（若最后一个会话被关闭，回到文件表）。
  - `Alt+←/Alt+→` 在会话间向左/向右切换。
  - `Enter` 在文件表中切换/激活会话（若已在会话栏存在则切换，否则新建）。
- MAY：提供 `/open <path|slug>`、`/switch <index|title>`、`/close [<index|title>]` 斜杠命令。

## 5. 状态与一致性
- MUST：每个会话的日志与输入历史互不影响；切换时不清空输入框。
- MUST：当 `specPath` 文件被重命名/删除时，UI 给出提示并提供“重新定位/关闭会话”选项。
- SHOULD：会话栏标题动态反映 frontmatter.title 的变化（当文件保存/重新读取时）。
- SHOULD：渲染宽度变化时，仅对当前会话触发 Markdown 重新渲染（避免全部重渲染）。

## 6. 持久化与导出（可选）
- 默认内存：会话日志与输入历史默认仅存在于内存，不强制落盘。
- 导出（建议）：
  - 目标路径：`vibe-docs/spec/chats/<slug>/YYYYMMDD-HHMMSS.chat.mdx`。
  - Frontmatter 建议字段：`title`, `relatedSpec`, `createdAt`, `lastUpdated`。
  - 正文：以时间序列记录“角色（system/user/assistant/notice）+ 文本”。
- 导入（可选）：允许从 `.chat.mdx` 恢复为一个会话（前期可不实现）。

## 7. 性能与资源
- MUST：会话切换 O(1)；日志增长到上限时滚动截断或按大小清理。
- SHOULD：对 Markdown 渲染结果维持按文件路径 + 宽度的二级缓存，命中后复用（已有实现可复用）。
- MAY：限制同时打开会话的数量（例如 10 个），超限时提示。

## 8. 可用性与无障碍
- MUST：完整键盘路径；对焦与高亮明确，可见的切换反馈。
- SHOULD：在状态栏/通知处显示“当前会话标题”和“会话计数 N/Total”。

## 9. 兼容性与降级
- 当终端不支持某些组合键时，提供替代键位或斜杠命令。
- 会话功能不可用时，仍可单会话使用 Spec 工作台（降级）。

## 10. Conformance（用例片段）
- 打开两个不同的 `.spec.mdx`，切换后各自保持滚动位置与输入框内容。
- 关闭当前会话后，自动激活最邻近的会话；当剩余 0 个时回到文件表。
- 重命名已打开的 `.spec.mdx` 后，会话标题与路径提示同步更新。

## 11. 变更记录
- 0.1.0：初稿（草案）。

