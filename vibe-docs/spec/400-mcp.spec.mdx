---
title: MCP Management Spec (Draft)
specVersion: 0.1.0
lastUpdated: {auto}
---

# MCP — 管理与配置规范（草案）

本规范定义 codectl 对 MCP（Model Context Protocol）服务端/客户端的注册、配置、运行与健康检查方式。
目标是：以规范为唯一真源，提供人可读、机可验的描述，使 CLI/TUI、配置文件与 CI 校验保持一致。

> 术语：RFC2119 关键字（MUST/SHOULD/MAY 等）具有规范性含义。

## 1. 目标与非目标

- 目标
  - 统一管理 MCP 服务器（本地/远端），含注册、启停、健康检查、导入导出。
  - 提供可验证的配置模型与 JSON Schema（见 `mcp.schema.json`）。
  - 在 TUI/CLI 中以一致方式展示状态与执行操作。
- 非目标
  - 不实现自有 MCP 协议栈；以现有 MCP 实现为准（stdio/ws/sse/http）。
  - 不托管用户密钥内容；仅引用系统安全存储或环境变量。

## 2. 范围与概念

- MCP Server：实现 MCP 的服务端进程或远端服务。
- Transport：与服务端交互方式，`stdio|ws|sse|http`。
- StartSpec：如何在本机启动服务（命令/脚本/Docker 等）。
- Registry：codectl 记录的 MCP 实例清单与状态。

## 3. 配置模型（规范）

配置文件遵循 JSON Schema（见 `./mcp.schema.json`）。实现必须支持：

- 全局：`$XDG_CONFIG_HOME/codectl/mcp/config.json`（macOS: `~/Library/Application Support/codectl/mcp/config.json`）。
- 项目级（覆盖全局）：`./.codectl/mcp/config.json` 或 `./vibe-docs/mcp/config.json`（二选一，优先前者）。

实现 MUST 合并多层配置（项目级优先），字段按对象深度合并、数组按 `id` 去重并覆盖。

### 3.1 示例（JSON 形态，仅示意）

```json
{
  "version": 1,
  "servers": [
    {
      "id": "local-embeddings",
      "name": "Local Embeddings Server",
      "enabled": true,
      "autostart": false,
      "transport": "stdio",
      "start": {
        "kind": "command",
        "command": "node",
        "args": ["server.js"],
        "cwd": "./servers/embeddings",
        "env": { "OPENAI_API_KEY": "${env:OPENAI_API_KEY}" }
      },
      "health": {
        "kind": "command",
        "command": "node",
        "args": ["healthcheck.js"],
        "timeoutSec": 5
      },
      "permissions": {
        "allowNetwork": true,
        "fs": [{ "path": "./data", "mode": "ro" }]
      },
      "profiles": ["default"]
    },
    {
      "id": "remote-rag",
      "name": "Remote RAG Service",
      "enabled": false,
      "transport": "ws",
      "endpoint": "wss://mcp.example.com/socket",
      "credentials": [{ "type": "env", "key": "RAG_TOKEN" }]
    }
  ]
}
```

## 4. CLI/TUI 行为（规范）

### 4.1 子命令

- `codectl mcp list [--json]`（规划中）
  - MUST 列出合并后有效的 MCP 服务器，含 `id|name|enabled|status|transport|endpoint|autostart`。
  - `--json` 输出 MUST 符合 `ListOutput.schema`（后续补充）。
  - 退出码：0 成功；>0 读取/解析错误。

- `codectl mcp remove <id>`（规划中）：从当前作用域配置中移除（不影响其他层）。

- `codectl mcp enable|disable <id>`：切换启用状态（就近写入作用域配置）。

- `codectl mcp start <id> [--foreground|--detach]` / `stop <id>` / `restart <id>`
  - 当 `transport=stdio` 且定义了 `start.kind=command|docker` 时，MUST 支持本地启动与停止。
  - MUST 在 `~/.local/state/codectl/mcp/<id>/` 写入 pid 与日志（平台等价目录）。

- `codectl mcp doctor [<id>] [--fix]`（规划中）
  - MUST 执行以下检查并返回 JSON：
    - 二进制/运行时存在性（node/docker）
    - 端口/网络连通性（ws/sse/http）
    - 健康检查（见 5）
  - `--fix` 允许执行可安全修复项（例如安装缺失二进制的提示脚本）。

- `codectl mcp export <id>`（规划中）

TUI MUST 新增 MCP 面板：展示列表、状态、快捷操作（回车展开、`s` 启停、`e` 启用/禁用、`r` 诊断）。

### 4.2 退出码（片段）

- 0：成功；1：未知错误；2：参数/冲突；3：配置读取/解析失败；4：运行时缺失；5：健康检查失败；6：启动失败。

## 5. 健康检查（规范）

健康检查 MUST 支持以下方式之一：

- `kind=command`：执行命令（成功=exit 0），可解析标准输出关键字。
- `kind=http`：请求 `endpoint+path`，期望 200/JSON Key（可配置）。
- `kind=mcp`：发起握手/`ping` 消息（当客户端实现可用时）。

每个服务器可定义 `initialDelaySec`、`timeoutSec`、`intervalSec`。`doctor` 应并发执行检查并汇总详细结果。

## 6. 安全与凭据

- 配置文件 MUST 不包含明文密钥；凭据以引用方式表达：
  - `${env:VAR}` 使用进程环境。
  - `${keychain:service/account}` 使用系统安全存储（macOS Keychain/Secret Service/Windows Credential Manager）。
  - `${file:~/.secrets/foo}` 仅指向本地文件路径（不建议）。
- `codectl mcp enable|disable` 等操作 MUST 不回显密钥内容。

## 7. 规范文件与机读接口

- JSON Schema：`./mcp.schema.json` 定义配置结构，CLI/TUI 在读/写/导入导出时 MUST 校验。
- Conformance 用例：`./conformance/mcp-*.mdx` 描述输入/期望输出与退出码。
- 规范映射（追踪）：`./traceability.json` 标注本规范条款 ID 与实现/测试对应关系。

## 8. 兼容性

- `specVersion` 采用语义化版本。配置 `version` 字段不兼容升级时，CLI MUST 给出迁移提示并拒绝写入。

## 9. 开放问题

- 远端托管（SaaS）MCP 的认证标准化（Bearer/OAuth）如何抽象在凭据模型中。
- Docker 启停的跨平台参数与最小权限模型。
- 与编辑器生态（VSCode/Neovim）共享 MCP 列表的路径与协议。

---
本文件为草案，优先在规范层对齐；实现应在合并前通过基本 Conformance 用例。
