---
title: TUI — Spec UI 界面规范
specVersion: 0.1.0
status: draft
lastUpdated: {auto}
---

# TUI — Spec UI 界面规范（草案）

本规范定义“Spec 工作台”的界面布局、键位交互、渲染与性能要求，使其作为 SDD（Spec → Task → Coding）工作流的主要工作区。多会话能力见《410-specui-sessions.spec.mdx》。

## 1. 目标与非目标
- 目标
  - 在单屏内完成“浏览规范、查看上下文日志、输入对话/命令”的闭环。
  - 最小打扰：只读预览 Markdown，不承担重编辑任务（编辑可交给外部编辑器）。
  - 键盘优先、稳定渲染、宽度自适应，支持快速切换焦点与刷新。
- 非目标
  - 不实现富文本编辑；不内嵌完整终端（可选计划）。

## 2. 布局与区域
- 左侧：文件管理器（File Tree/Table）
  - 根目录：`<repo>/vibe-docs/`，展示其中的 `spec/`、`task/` 等子目录。
  - 以表格单列呈现，包含树形前缀符号与 Nerd 图标（文件/文件夹/展开态）。
- 中间：Markdown 预览（Preview）
  - 使用 glamour 渲染为 ANSI；支持“快速模式”（fastMode）减少装饰以提升性能。
  - 视口（viewport）支持滚动，保持当前位置状态。
- 右侧：日志面板（Logs）
  - 展示用户输入、命令回显与提示信息；自动滚动至底部。
- 底部：输入框（Input）
  - 占一行，接受“对话文本”与“一次性命令”。
  - 占位提示：输入对话（前缀 ! 执行命令），Esc 返回列表。

## 3. 焦点与键位（MUST/SHOULD）
- 焦点区域：Files / Preview / Input（见 2 节）。
- MUST 提供以下焦点切换：
  - `Ctrl+H` → Files；`Ctrl+L` → Preview；`Ctrl+J` → Input；`Ctrl+K` 恢复上一次顶部焦点。
  - `Esc`：从 Preview/Input 返回 Files；在 Files 保持不变。
  - `Ctrl+C` 或 `q`：退出 Spec UI。
- 文件区（Files）
  - `Enter`：若为目录则“展开/折叠”；若为文件则在 Preview 渲染该文件。
  - `←`/`Backspace`：在目录上“折叠”；在子项上返回父目录并选中父项。
  - 上下移动由表格组件负责，支持 PageUp/PageDown（组件默认行为）。
- 预览区（Preview）
  - 通过 viewport 键位滚动（组件默认行为）。
  - `f`：切换快速模式（fastMode）并重新渲染当前文件。
  - `r`：重新渲染当前文件（用于手工刷新）。
- 输入区（Input）
  - `Enter`：提交内容。
    - 以 `!<命令>` 前缀开头时，作为一次性 shell 命令在工作目录执行（超时 20s），标准输出/错误写入日志面板。
    - 否则作为“对话消息”写入日志（无外部调用）。

## 4. 文件树与可见性规则
- 根目录固定为 `vibe-docs/`；初始仅展开根层。
- 可见列表 = 根 + 所有“已展开目录”的直接子项；深度遍历仅进入“展开”的节点（避免深度成本）。
- 行文样式：
  - 目录：`▸`/`▾` 指示展开状态，附加 Nerd 图标；文件保留文件名。
  - 光标行高亮；点击当前行视为 `Enter` 行为。

## 5. Markdown 渲染与缓存
- MUST 使用 glamour 渲染，并按“文件路径 + 视口宽度”建立二级缓存条目：
  - 条目：`{ out, modUnix, size }`；当检测到文件修改时间/大小变化或宽度变化时失效并重渲染。
- 视口宽度计算需考虑左右边框与左右内边距（gutter）。
- SHOULD 提供快速模式（fastMode）以降低渲染装饰、提升渲染速度；`f` 切换。

## 6. 日志与命令执行
- 日志面板记录：对话文本、命令回显与状态提示；新消息追加并自动滚动到底。
- `!<命令>` 在当前工作目录（默认 Git Root）下执行；
  - MUST 设置合理超时（例如 20s）；超时/错误写入日志。
  - SHOULD 追加 `> <命令>` 的提示行以增强可读性。

## 7. 性能与稳定性
- MUST：不同区域宽度固定后，渲染不应产生左右跳动；仅在尺寸变化时重新计算。
- MUST：在文件修改/宽度变化外不重复渲染；命中缓存直接复用。
- SHOULD：首开时显示“渲染中…”占位；失败时显示“读取/渲染失败：<err>”。

## 8. 可用性与无障碍
- MUST：全键盘可达；焦点区域的边框高亮区分。
- SHOULD：状态栏显示当前时间与轻量状态信息（如错误消息）。
- SHOULD：面向深色主题的默认配色，保持文本对比度。

## 9. 安全与边界
- `!` 命令执行具有风险：
  - 不持久化命令输出（仅内存日志）；不回显敏感环境变量值。
  - 建议限制在仓库根目录下执行；未来可提供白名单（规划）。
- 终端（PTY）集成暂不启用；若启用需单独规范其键位与权限模型（见多会话/扩展规范）。

## 10. Conformance（片段）
1) 打开 Spec UI 后，初始焦点在 Files；按 `Enter` 渲染选中文件；`Esc` 返回 Files。
2) 在 Input 输入 `!echo hello` 并回车：日志面板出现 `> echo hello` 与 `hello`。
3) 切换 `f`：当前文件重新渲染；再次 `f` 恢复；宽度变化时自动重新渲染。

## 11. 变更记录
- 0.1.0：初稿（草案）。

